{% extends "base.html" %}

{% block title %}Add Account - Money Tracker{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Add New Account</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="name" class="form-label">Account Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="account_type" class="form-label">Account Type</label>
                        <select class="form-select" id="account_type" name="account_type" required>
                            <option value="">Select account type</option>
                            <option value="checking">Checking</option>
                            <option value="savings">Savings</option>
                            <option value="investment">Investment</option>
                            <option value="credit">Credit Card</option>
                        </select>
                    </div>
                    
                    <!-- Bank Information Section -->
                    <div class="mb-3">
                        <label for="routing_number" class="form-label">Bank Routing Number (Optional)</label>
                        <input type="text" class="form-control" id="routing_number" name="routing_number" maxlength="9" placeholder="123456789">
                        <div class="form-text">9-digit routing number for automatic bank identification</div>
                        <div id="bank-info" class="mt-2" style="display: none;">
                            <div class="alert alert-info">
                                <strong id="bank-name"></strong><br>
                                <small id="bank-region"></small>
                            </div>
                        </div>
                        <div id="routing-error" class="text-danger mt-1" style="display: none;"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bank_name" class="form-label">Bank Name (Optional)</label>
                        <input type="text" class="form-control" id="bank_name" name="bank_name" placeholder="Will be auto-filled from routing number">
                        <div class="form-text">This will be automatically filled if you enter a routing number</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="account_number" class="form-label">Account Number (Optional)</label>
                        <input type="text" class="form-control" id="account_number" name="account_number" placeholder="Enter full account number">
                        <div class="form-text">
                            <i class="fas fa-shield-alt text-warning me-1"></i>
                            Full account number will be stored securely. Only last 4 digits will be displayed in lists.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="balance" class="form-label">Initial Balance</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" step="0.01" class="form-control" id="balance" name="balance" value="0.00">
                        </div>
                        <div class="form-text">Enter negative amount for credit card debt</div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('accounts') }}" class="btn btn-secondary me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">Add Account</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const routingInput = document.getElementById('routing_number');
    const bankNameInput = document.getElementById('bank_name');
    const bankInfo = document.getElementById('bank-info');
    const bankNameDisplay = document.getElementById('bank-name');
    const bankRegionDisplay = document.getElementById('bank-region');
    const routingError = document.getElementById('routing-error');
    
    let lookupTimeout;
    
    routingInput.addEventListener('input', function() {
        const routingNumber = this.value.replace(/\D/g, ''); // Remove non-digits
        this.value = routingNumber; // Update input with cleaned value
        
        // Clear previous timeout
        clearTimeout(lookupTimeout);
        
        // Hide previous results
        bankInfo.style.display = 'none';
        routingError.style.display = 'none';
        
        if (routingNumber.length === 9) {
            // Add a small delay to avoid too many API calls
            lookupTimeout = setTimeout(() => {
                lookupBank(routingNumber);
            }, 500);
        } else if (routingNumber.length > 9) {
            // Trim to 9 digits
            this.value = routingNumber.substring(0, 9);
            lookupBank(this.value);
        } else {
            // Clear bank name if routing number is incomplete
            bankNameInput.value = '';
        }
    });
    
    function lookupBank(routingNumber) {
        fetch(`/api/lookup-bank/${routingNumber}`)
            .then(response => response.json())
            .then(data => {
                if (data.valid && data.bank_name) {
                    // Display bank information
                    bankNameDisplay.textContent = data.bank_name;
                    bankRegionDisplay.textContent = `Region: ${data.region}`;
                    bankInfo.style.display = 'block';
                    
                    // Auto-fill bank name
                    bankNameInput.value = data.bank_name;
                    
                    // Add success styling
                    routingInput.classList.remove('is-invalid');
                    routingInput.classList.add('is-valid');
                } else {
                    // Show error
                    routingError.textContent = data.error || 'Bank not found for this routing number';
                    routingError.style.display = 'block';
                    routingInput.classList.remove('is-valid');
                    routingInput.classList.add('is-invalid');
                    
                    // Clear bank name
                    bankNameInput.value = '';
                }
            })
            .catch(error => {
                console.error('Error looking up bank:', error);
                routingError.textContent = 'Error looking up bank information';
                routingError.style.display = 'block';
                routingInput.classList.remove('is-valid');
                routingInput.classList.add('is-invalid');
            });
    }
    
    // Handle full account number input - last 4 digits extracted automatically in backend
    const accountNumberInput = document.getElementById('account_number');
    
    if (accountNumberInput) {
        accountNumberInput.addEventListener('input', function() {
            // Optional: Add formatting or validation here if needed
            console.log('Account number entered:', this.value);
        });
    }
});
</script>
{% endblock %}